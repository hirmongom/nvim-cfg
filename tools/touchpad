#!/bin/bash

set -euo pipefail

SHOW_NOTIFY=0
MODE=""

usage()
{
  echo "Usage:"
  echo "  touchpad [--notify|-n] [--enable|-e | --disable|-d | --toggle|-t]"
  exit 1
}

toggle()
{
  STATE=$(gsettings get org.gnome.desktop.peripherals.touchpad send-events)

  if [ "$STATE" = "'enabled'" ]; then
    gsettings set org.gnome.desktop.peripherals.touchpad send-events 'disabled'
    if [ $SHOW_NOTIFY -eq 1 ]; then
      notify-send -h int:transient:1 -a "Touchpad" "Disabled"
    fi
  else
    gsettings set org.gnome.desktop.peripherals.touchpad send-events 'enabled'
    if [ $SHOW_NOTIFY -eq 1 ]; then
      notify-send -h int:transient:1 -a "Touchpad" "Enabled"
    fi
  fi
}

enable()
{
  gsettings set org.gnome.desktop.peripherals.touchpad send-events 'enabled'
  if [ $SHOW_NOTIFY -eq 1 ]; then
    notify-send -h int:transient:1 -a "Touchpad" "Enabled"
  fi
}

disable()
{
  gsettings set org.gnome.desktop.peripherals.touchpad send-events 'disabled'
  if [ $SHOW_NOTIFY -eq 1 ]; then
    notify-send -h int:transient:1 -a "Touchpad" "Disabled"
  fi
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    -n | --notify)
      SHOW_NOTIFY=1
      ;;
    -e | --enable)
      if [ -n "$MODE" ]; then
        echo "Error: multiple mode options provided"
        exit 1
      fi
      MODE="enable"
      ;;
    -d | --disable)
      if [ -n "$MODE" ]; then
        echo "Error: multiple mode options provided"
        exit 1
      fi
      MODE="disable"
      ;;
    -t | --toggle)
      if [ -n "$MODE" ]; then
        echo "Error: multiple mode options provided"
        exit 1
      fi
      MODE="toggle"
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Error: unknown option '$1'"
      exit 1
      ;;
    *)
      echo "Error: unexpected argument '$1'"
      exit 1
      ;;
  esac
  shift
done

# Require a mode
if [ -z "$MODE" ]; then
  usage
  exit 1
fi

case "$MODE" in
  enable)
    enable
    ;;
  disable)
    disable
    ;;
  toggle)
    toggle
    ;;
  *)
    echo "Internal error: invalid mode '$MODE'"
    exit 1
    ;;
esac
